---
import Layout from '../layouts/Layout.astro';
import { DAILY_TARGETS, SAMPLE_DAILY_MEALS } from '../data/mealplan';

export const prerender = false;

// Use Eastern timezone for date
const easternDate = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
const nowEastern = new Date(easternDate);
const today = nowEastern.toISOString().split('T')[0];

const proteinTarget = DAILY_TARGETS.protein;
const waterTarget = DAILY_TARGETS.waterGallons * 3.785; // Convert to liters for display
---

<Layout title="Nutrition" activeNav="nutrition">
  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Nutrition</h1>
        <p class="text-gray-500">Track meals and macros</p>
      </div>
      <label for="date-picker" class="sr-only">Select date</label>
      <input type="date" id="date-picker" value={today} class="rounded-xl" />
    </div>

    <!-- Daily Targets Banner -->
    <div class="card bg-gradient-to-r from-green-50 to-blue-50 border-green-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">{DAILY_TARGETS.protein}g</div>
            <div class="text-xs text-gray-500">Protein Goal</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-orange-600">{DAILY_TARGETS.caloriesMin}-{DAILY_TARGETS.caloriesMax}</div>
            <div class="text-xs text-gray-500">Calories</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">{DAILY_TARGETS.waterGallons} gal</div>
            <div class="text-xs text-gray-500">Water</div>
          </div>
        </div>
        <a href="/meal-prep" class="btn btn-ghost text-sm">
          Meal Prep â†’
        </a>
      </div>
    </div>

    <!-- Daily Summary -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="stat-card">
        <div class="stat-value" id="total-calories">0</div>
        <div class="stat-label">Calories</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-green-500" id="total-protein">0g</div>
        <div class="stat-label">Protein</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-blue-500" id="total-carbs">0g</div>
        <div class="stat-label">Carbs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value text-yellow-500" id="total-fat">0g</div>
        <div class="stat-label">Fat</div>
      </div>
    </div>

    <!-- Protein Progress -->
    <div class="card">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Protein Target</h3>
        <span class="text-sm text-gray-500" id="protein-target-label">0 / {DAILY_TARGETS.protein}g</span>
      </div>
      <div class="progress-bar h-3">
        <div class="progress-fill bg-gradient-to-r from-green-400 to-green-500" id="protein-progress" style="width: 0%"></div>
      </div>
    </div>

    <!-- Quick Add Water - Prominent -->
    <div class="card bg-blue-50 border-blue-200">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">ðŸ’§</span>
        <div>
          <h3 class="font-semibold text-blue-800">Water Intake</h3>
          <p class="text-xs text-blue-600">Goal: 1 gallon (~3.8L) daily</p>
        </div>
      </div>
      <div class="flex items-center gap-4 mb-3">
        <div class="flex-1">
          <div class="progress-bar h-4">
            <div class="progress-fill bg-gradient-to-r from-blue-400 to-blue-500" id="water-progress" style="width: 0%"></div>
          </div>
        </div>
        <span class="text-lg font-bold text-blue-600" id="water-label">0 / 3.8L</span>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button class="water-btn btn bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm" data-amount="0.25">+250ml</button>
        <button class="water-btn btn bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm" data-amount="0.5">+500ml</button>
        <button class="water-btn btn bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm" data-amount="0.75">+750ml</button>
        <button class="water-btn btn bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm font-semibold" data-amount="1">+1L</button>
      </div>
    </div>

    <!-- Quick Add Meals -->
    <div class="card">
      <h3 class="font-semibold mb-4">Quick Add</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="50" data-calories="700" data-fat="50">
          <div class="font-medium">Ribeye (8oz)</div>
          <div class="text-xs text-gray-500">50g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="30" data-calories="350" data-fat="20">
          <div class="font-medium">Ground Beef (6oz)</div>
          <div class="text-xs text-gray-500">30g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="12" data-calories="140" data-fat="10">
          <div class="font-medium">Eggs (2)</div>
          <div class="text-xs text-gray-500">12g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="10" data-calories="180" data-fat="14">
          <div class="font-medium">Bacon (4 strips)</div>
          <div class="text-xs text-gray-500">10g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="35" data-calories="300" data-fat="15">
          <div class="font-medium">Salmon (6oz)</div>
          <div class="text-xs text-gray-500">35g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="25" data-calories="300" data-fat="20">
          <div class="font-medium">Burger Patty</div>
          <div class="text-xs text-gray-500">25g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="40" data-calories="400" data-fat="20">
          <div class="font-medium">Chicken Thighs</div>
          <div class="text-xs text-gray-500">40g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="35" data-calories="350" data-fat="18">
          <div class="font-medium">Pork Chop</div>
          <div class="text-xs text-gray-500">35g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="25" data-calories="150" data-fat="3">
          <div class="font-medium">Protein Shake</div>
          <div class="text-xs text-gray-500">25g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="20" data-calories="280" data-fat="10">
          <div class="font-medium">Greek Yogurt</div>
          <div class="text-xs text-gray-500">20g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="5" data-calories="160" data-fat="13">
          <div class="font-medium">Cashews (1oz)</div>
          <div class="text-xs text-gray-500">5g protein</div>
        </button>
        <button class="quick-meal btn btn-secondary text-left p-4" data-protein="7" data-calories="170" data-fat="14">
          <div class="font-medium">Peanuts (1oz)</div>
          <div class="text-xs text-gray-500">7g protein</div>
        </button>
      </div>
    </div>

    <!-- Food Search (USDA Database) -->
    <div class="card">
      <h3 class="font-semibold mb-4">Search Food Database</h3>
      <div class="flex gap-2 mb-4">
        <label for="food-search" class="sr-only">Search foods</label>
        <input type="text" id="food-search" placeholder="Search foods (e.g., ribeye, chicken breast)..." class="flex-1" />
        <button id="search-btn" class="btn btn-primary">Search</button>
      </div>
      <div id="search-results" class="space-y-2 hidden">
        <!-- Results will be populated here -->
      </div>
    </div>

    <!-- Log Custom Meal -->
    <div class="card">
      <h3 class="font-semibold mb-4">Log Meal</h3>
      <form id="meal-form" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-500 mb-1">Meal Type</label>
            <select id="meal-type" class="w-full">
              <option value="breakfast">Breakfast</option>
              <option value="lunch">Lunch</option>
              <option value="dinner">Dinner</option>
              <option value="snack">Snack</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-500 mb-1">Description</label>
            <input type="text" id="meal-desc" placeholder="What did you eat?" class="w-full" />
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm text-gray-500 mb-1">Calories</label>
            <input type="number" id="meal-calories" placeholder="0" class="w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-500 mb-1">Protein (g)</label>
            <input type="number" id="meal-protein" placeholder="0" class="w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-500 mb-1">Carbs (g)</label>
            <input type="number" id="meal-carbs" placeholder="0" class="w-full" />
          </div>
          <div>
            <label class="block text-sm text-gray-500 mb-1">Fat (g)</label>
            <input type="number" id="meal-fat" placeholder="0" class="w-full" />
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Log Meal</button>
      </form>
    </div>

    <!-- Today's Meals -->
    <div class="card">
      <h3 class="font-semibold mb-4">Today's Meals</h3>
      <div id="meals-list" class="space-y-3">
        <p class="text-gray-400 text-sm">No meals logged yet</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  const datePicker = document.getElementById('date-picker') as HTMLInputElement;
  let currentDate = datePicker?.value || new Date().toISOString().split('T')[0];

  async function loadNutrition(date: string) {
    try {
      const res = await fetch(`/api/nutrition?date=${date}`);
      const data = await res.json();

      const nutrition = data.nutrition || { calories: 0, protein: 0, carbs: 0, fat: 0 };
      const meals = data.meals || [];

      document.getElementById('total-calories')!.textContent = nutrition.calories || '0';
      document.getElementById('total-protein')!.textContent = (nutrition.protein || 0) + 'g';
      document.getElementById('total-carbs')!.textContent = (nutrition.carbs || 0) + 'g';
      document.getElementById('total-fat')!.textContent = (nutrition.fat || 0) + 'g';

      // Protein progress
      const proteinTarget = 200; // Updated target from mealplan.ts
      const proteinPct = Math.min(100, ((nutrition.protein || 0) / proteinTarget) * 100);
      document.getElementById('protein-progress')!.style.width = proteinPct + '%';
      document.getElementById('protein-target-label')!.textContent = `${nutrition.protein || 0} / ${proteinTarget}g`;

      // Meals list
      const mealsList = document.getElementById('meals-list')!;
      if (meals.length > 0) {
        mealsList.innerHTML = meals.map((m: any) => `
          <div class="flex items-center justify-between py-2 border-b border-gray-100 group">
            <div>
              <span class="font-medium">${m.description || m.meal_type}</span>
              <span class="text-xs text-gray-400 ml-2">${m.meal_type}</span>
            </div>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-500">
                ${m.protein}g protein â€¢ ${m.calories} cal
              </span>
              <button class="delete-meal text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-id="${m.id}" title="Delete">âœ•</button>
            </div>
          </div>
        `).join('');

        // Add delete handlers
        mealsList.querySelectorAll('.delete-meal').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = (e.currentTarget as HTMLElement).dataset.id;
            if (confirm('Delete this meal?')) {
              await deleteMeal(id!);
            }
          });
        });
      } else {
        mealsList.innerHTML = '<p class="text-gray-400 text-sm">No meals logged yet</p>';
      }

      // Load water for the selected date
      loadWater(date);
    } catch (err) {
      console.error('Failed to load nutrition:', err);
    }
  }

  async function loadWater(date: string) {
    try {
      const res = await fetch(`/api/water?date=${date}`);
      const data = await res.json();
      const waterTotal = data.total || 0;
      const waterTarget = 3.8; // 1 gallon in liters
      const waterPct = Math.min(100, (waterTotal / waterTarget) * 100);
      document.getElementById('water-progress')!.style.width = waterPct + '%';
      document.getElementById('water-label')!.textContent = `${waterTotal.toFixed(1)} / ${waterTarget}L`;
    } catch (err) {
      console.error('Failed to load water:', err);
    }
  }

  async function logWater(amount: number) {
    try {
      const res = await fetch('/api/water', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount_liters: amount, date: currentDate })
      });
      if (res.ok) {
        loadWater(currentDate);
      }
    } catch (err) {
      console.error('Failed to log water:', err);
    }
  }

  async function logMeal(mealData: any) {
    try {
      const res = await fetch('/api/nutrition', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'meal',
          date: currentDate,
          ...mealData
        })
      });

      if (res.ok) {
        loadNutrition(currentDate);
      }
    } catch (err) {
      console.error('Failed to log meal:', err);
    }
  }

  async function deleteMeal(mealId: string) {
    try {
      const res = await fetch('/api/nutrition', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          type: 'delete_meal',
          meal_id: parseInt(mealId),
          date: currentDate
        })
      });

      if (res.ok) {
        loadNutrition(currentDate);
      }
    } catch (err) {
      console.error('Failed to delete meal:', err);
    }
  }

  // Date picker change
  datePicker?.addEventListener('change', (e) => {
    currentDate = (e.target as HTMLInputElement).value;
    loadNutrition(currentDate);
  });

  // Food search
  async function searchFood(query: string) {
    const resultsDiv = document.getElementById('search-results')!;
    resultsDiv.classList.remove('hidden');
    resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">Searching...</p>';

    try {
      const res = await fetch(`/api/food-search?q=${encodeURIComponent(query)}`);
      const data = await res.json();

      if (data.foods && data.foods.length > 0) {
        resultsDiv.innerHTML = data.foods.map((food: any) => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 cursor-pointer food-result"
               data-name="${food.name}"
               data-calories="${food.calories}"
               data-protein="${food.protein}"
               data-carbs="${food.carbs}"
               data-fat="${food.fat}">
            <div>
              <div class="font-medium">${food.name}</div>
              <div class="text-xs text-gray-500">${food.servingSize || '100g'}</div>
            </div>
            <div class="text-right text-sm">
              <div class="text-brand-orange font-medium">${food.protein}g protein</div>
              <div class="text-gray-500">${food.calories} cal â€¢ ${food.fat}g fat</div>
            </div>
          </div>
        `).join('');

        // Add click handlers to add food
        resultsDiv.querySelectorAll('.food-result').forEach(el => {
          el.addEventListener('click', () => {
            const foodEl = el as HTMLElement;
            logMeal({
              meal_type: 'snack',
              description: foodEl.dataset.name,
              calories: parseInt(foodEl.dataset.calories || '0'),
              protein: parseInt(foodEl.dataset.protein || '0'),
              carbs: parseInt(foodEl.dataset.carbs || '0'),
              fat: parseInt(foodEl.dataset.fat || '0')
            });
            resultsDiv.classList.add('hidden');
            (document.getElementById('food-search') as HTMLInputElement).value = '';
          });
        });

        if (data.fallback) {
          resultsDiv.innerHTML += '<p class="text-xs text-gray-400 mt-2">Using local database (USDA unavailable)</p>';
        }
      } else {
        resultsDiv.innerHTML = '<p class="text-gray-400 text-sm">No foods found. Try a different search.</p>';
      }
    } catch (err) {
      console.error('Search error:', err);
      resultsDiv.innerHTML = '<p class="text-red-500 text-sm">Search failed. Try again.</p>';
    }
  }

  document.getElementById('search-btn')?.addEventListener('click', () => {
    const query = (document.getElementById('food-search') as HTMLInputElement).value.trim();
    if (query) searchFood(query);
  });

  document.getElementById('food-search')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const query = (e.target as HTMLInputElement).value.trim();
      if (query) searchFood(query);
    }
  });

  // Water buttons
  document.querySelectorAll('.water-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const amount = parseFloat((e.currentTarget as HTMLElement).dataset.amount || '0.5');
      logWater(amount);
    });
  });

  // Quick meal buttons
  document.querySelectorAll('.quick-meal').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const protein = parseInt(target.dataset.protein || '0');
      const calories = parseInt(target.dataset.calories || '0');
      const fat = parseInt(target.dataset.fat || '0');
      const description = target.querySelector('.font-medium')?.textContent || '';

      logMeal({
        meal_type: 'snack',
        description,
        calories,
        protein,
        carbs: 0,
        fat
      });
    });
  });

  // Meal form
  document.getElementById('meal-form')?.addEventListener('submit', (e) => {
    e.preventDefault();

    logMeal({
      meal_type: (document.getElementById('meal-type') as HTMLSelectElement).value,
      description: (document.getElementById('meal-desc') as HTMLInputElement).value,
      calories: parseInt((document.getElementById('meal-calories') as HTMLInputElement).value) || 0,
      protein: parseInt((document.getElementById('meal-protein') as HTMLInputElement).value) || 0,
      carbs: parseInt((document.getElementById('meal-carbs') as HTMLInputElement).value) || 0,
      fat: parseInt((document.getElementById('meal-fat') as HTMLInputElement).value) || 0
    });

    // Clear form
    (document.getElementById('meal-desc') as HTMLInputElement).value = '';
    (document.getElementById('meal-calories') as HTMLInputElement).value = '';
    (document.getElementById('meal-protein') as HTMLInputElement).value = '';
    (document.getElementById('meal-carbs') as HTMLInputElement).value = '';
    (document.getElementById('meal-fat') as HTMLInputElement).value = '';
  });

  // Load on page load
  loadNutrition(currentDate);
</script>
