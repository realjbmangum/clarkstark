---
import Layout from '../layouts/Layout.astro';

export const prerender = false;

const today = new Date().toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric'
});

const dayOfWeek = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();

const schedule: Record<string, { id: string; name: string }> = {
  monday: { id: 'upper_strength', name: 'Upper Strength - Push' },
  tuesday: { id: 'lower_power', name: 'Lower Power - Explosive' },
  wednesday: { id: 'upper_hypertrophy', name: 'Upper Hypertrophy - Pull' },
  thursday: { id: 'lower_hypertrophy', name: 'Lower Hypertrophy - Volume' },
  friday: { id: 'speed_arms', name: 'Speed & Arms Friday' },
  saturday: { id: 'active_recovery', name: 'Active Recovery' },
  sunday: { id: 'rest_day', name: 'Rest Day' },
};

const todaysWorkout = schedule[dayOfWeek] || schedule.monday;
---

<Layout title="Dashboard" activeNav="dashboard">
  <div class="space-y-8">
    <!-- Header -->
    <div>
      <h1 class="text-3xl font-bold">{today}</h1>
      <p class="text-gray-500 mt-1">Best Shape at 50 - Day by Day</p>
    </div>

    <!-- Today's Workout Card -->
    <div class="card bg-gradient-to-br from-brand-orange to-brand-peach text-white">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-white/80 text-sm uppercase tracking-wide">Today's Workout</p>
          <h2 class="text-2xl font-bold mt-1">{todaysWorkout.name}</h2>
        </div>
        <a href={`/workout?id=${todaysWorkout.id}`} class="bg-white text-brand-orange px-6 py-3 rounded-full font-semibold hover:shadow-lg transition-shadow">
          Start Workout ‚Üí
        </a>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="workouts-week">-</div>
        <div class="stat-label">Workouts This Week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="protein-today">-</div>
        <div class="stat-label">Protein Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="water-today">-</div>
        <div class="stat-label">Water (L)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="current-weight">-</div>
        <div class="stat-label">Current Weight</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <button id="log-water" class="btn btn-secondary py-4 text-center">
        üíß Log Water (+500ml)
      </button>
      <a href="/nutrition" class="btn btn-secondary py-4 text-center">
        üçó Log Meal
      </a>
      <a href="/metrics" class="btn btn-secondary py-4 text-center">
        üìè Log Metrics
      </a>
      <a href="/recipes" class="btn btn-secondary py-4 text-center">
        üìñ Recipes
      </a>
    </div>

    <!-- Progress Section -->
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Water Progress -->
      <div class="card">
        <h3 class="font-semibold mb-4">Water Intake</h3>
        <div class="flex items-center gap-4">
          <div class="flex-1">
            <div class="progress-bar">
              <div class="progress-fill" id="water-progress" style="width: 0%"></div>
            </div>
          </div>
          <span class="text-sm text-gray-500" id="water-label">0 / 3L</span>
        </div>
        <div class="flex gap-2 mt-4">
          <button class="water-btn btn btn-ghost text-sm" data-amount="0.25">+250ml</button>
          <button class="water-btn btn btn-ghost text-sm" data-amount="0.5">+500ml</button>
          <button class="water-btn btn btn-ghost text-sm" data-amount="0.75">+750ml</button>
          <button class="water-btn btn btn-ghost text-sm" data-amount="1">+1L</button>
        </div>
      </div>

      <!-- Protein Progress -->
      <div class="card">
        <h3 class="font-semibold mb-4">Protein Target</h3>
        <div class="flex items-center gap-4">
          <div class="flex-1">
            <div class="progress-bar">
              <div class="progress-fill" id="protein-progress" style="width: 0%"></div>
            </div>
          </div>
          <span class="text-sm text-gray-500" id="protein-label">0 / 150g</span>
        </div>
        <div class="flex gap-2 mt-4">
          <a href="/nutrition" class="btn btn-ghost text-sm">Log Meal ‚Üí</a>
        </div>
      </div>
    </div>

    <!-- Goals & Recent Activity -->
    <div class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="font-semibold mb-4">Active Goals</h3>
        <div id="goals-list" class="space-y-3">
          <p class="text-gray-400 text-sm">Loading goals...</p>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-4">This Week</h3>
        <div id="week-calendar" class="grid grid-cols-7 gap-2 text-center">
          {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((day, i) => (
            <div class="text-xs text-gray-400">{day}</div>
          ))}
          {[0, 1, 2, 3, 4, 5, 6].map((i) => (
            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-sm week-day" data-day={i}></div>
          ))}
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  async function loadDashboard() {
    try {
      const res = await fetch('/api/dashboard');
      const data = await res.json();

      // Update stats
      document.getElementById('workouts-week')!.textContent = data.week?.workoutsCompleted || '0';
      document.getElementById('protein-today')!.textContent = (data.today?.nutrition?.protein || 0) + 'g';
      document.getElementById('water-today')!.textContent = (data.today?.water || 0).toFixed(1);
      document.getElementById('current-weight')!.textContent = data.metrics?.current?.weight
        ? data.metrics.current.weight + ' lbs'
        : '-';

      // Update water progress
      const waterTarget = parseFloat(data.settings?.water_target_liters || '3');
      const waterTotal = data.today?.water || 0;
      const waterPct = Math.min(100, (waterTotal / waterTarget) * 100);
      document.getElementById('water-progress')!.style.width = waterPct + '%';
      document.getElementById('water-label')!.textContent = `${waterTotal.toFixed(1)} / ${waterTarget}L`;

      // Update protein progress
      const proteinTarget = parseInt(data.settings?.protein_target || '150');
      const proteinTotal = data.today?.nutrition?.protein || 0;
      const proteinPct = Math.min(100, (proteinTotal / proteinTarget) * 100);
      document.getElementById('protein-progress')!.style.width = proteinPct + '%';
      document.getElementById('protein-label')!.textContent = `${proteinTotal} / ${proteinTarget}g`;

      // Update goals
      const goalsList = document.getElementById('goals-list')!;
      if (data.goals && data.goals.length > 0) {
        goalsList.innerHTML = data.goals.map((g: any) => `
          <div class="flex items-center justify-between py-2 border-b border-gray-100">
            <span>${g.description || g.type}</span>
            <span class="text-sm text-gray-500">${g.current_value || '-'} / ${g.target_value} ${g.unit || ''}</span>
          </div>
        `).join('');
      } else {
        goalsList.innerHTML = '<p class="text-gray-400 text-sm">No active goals. <a href="/goals" class="text-brand-orange">Set one?</a></p>';
      }

    } catch (err) {
      console.error('Failed to load dashboard:', err);
    }
  }

  async function logWater(amount: number) {
    try {
      const res = await fetch('/api/water', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount_liters: amount })
      });
      if (res.ok) {
        loadDashboard(); // Refresh
      }
    } catch (err) {
      console.error('Failed to log water:', err);
    }
  }

  // Event listeners
  document.getElementById('log-water')?.addEventListener('click', () => logWater(0.5));

  document.querySelectorAll('.water-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const amount = parseFloat((e.target as HTMLElement).dataset.amount || '0.5');
      logWater(amount);
    });
  });

  // Load on page load
  loadDashboard();
</script>
