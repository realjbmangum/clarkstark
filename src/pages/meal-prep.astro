---
import Layout from '../layouts/Layout.astro';
import { PREP_TASKS, SHOPPING_LIST, MEAL_CONTAINERS, DAILY_TARGETS, getDailyProteinExample } from '../data/mealplan';

export const prerender = false;

const proteinExample = getDailyProteinExample();

// Group prep tasks by category
const tasksByCategory = {
  protein: PREP_TASKS.filter(t => t.category === 'protein'),
  sides: PREP_TASKS.filter(t => t.category === 'sides'),
  snacks: PREP_TASKS.filter(t => t.category === 'snacks'),
  prep: PREP_TASKS.filter(t => t.category === 'prep'),
};

// Group shopping list by category
const shoppingByCategory = {
  protein: SHOPPING_LIST.filter(i => i.category === 'protein'),
  produce: SHOPPING_LIST.filter(i => i.category === 'produce'),
  snacks: SHOPPING_LIST.filter(i => i.category === 'snacks'),
  pantry: SHOPPING_LIST.filter(i => i.category === 'pantry'),
};
---

<Layout title="Meal Prep" activeNav="meal-prep">
  <div class="space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold gradient-text">Meal Prep</h1>
        <p class="text-[var(--text-muted)] text-sm mt-1">Sunday ritual ‚Ä¢ ~1 hour to dominate the week</p>
      </div>
      <a href="/" class="px-4 py-2 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:border-[var(--brand-orange)] transition-all text-sm">
        ‚Üê Dashboard
      </a>
    </div>

    <!-- Daily Targets Reminder -->
    <div class="card card-glow p-5">
      <h3 class="font-semibold text-[var(--text-primary)] mb-4 flex items-center gap-2">
        <span class="text-xl">üéØ</span>
        Daily Targets
      </h3>
      <div class="grid grid-cols-3 gap-4 text-center">
        <div class="p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)]">
          <div class="text-3xl font-black text-[var(--brand-green)]">{DAILY_TARGETS.protein}g</div>
          <div class="text-xs text-[var(--text-muted)] mt-1 uppercase tracking-wide">Protein</div>
        </div>
        <div class="p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)]">
          <div class="text-2xl font-black gradient-text">{DAILY_TARGETS.caloriesMin}-{DAILY_TARGETS.caloriesMax}</div>
          <div class="text-xs text-[var(--text-muted)] mt-1 uppercase tracking-wide">Calories</div>
        </div>
        <div class="p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)]">
          <div class="text-3xl font-black text-[var(--brand-cyan)]">{DAILY_TARGETS.waterGallons} gal</div>
          <div class="text-xs text-[var(--text-muted)] mt-1 uppercase tracking-wide">Water</div>
        </div>
      </div>
    </div>

    <!-- Water Bottle Reminder -->
    <div class="card p-5 border-[var(--brand-cyan)] border-opacity-50" style="border-color: rgba(0, 212, 255, 0.3);">
      <div class="flex items-center gap-4">
        <div class="text-4xl">üíß</div>
        <div class="flex-1">
          <h3 class="font-semibold text-[var(--brand-cyan)]">Water Jug Check</h3>
          <p class="text-sm text-[var(--text-secondary)]">Fill your 1-gallon jug for tomorrow. Keep it visible!</p>
        </div>
        <label class="relative flex items-center cursor-pointer">
          <input type="checkbox" id="water-check" class="sr-only peer" />
          <div class="w-14 h-8 rounded-full bg-[var(--bg-glass)] border border-[var(--border-color)] peer-checked:bg-[var(--brand-cyan)] peer-checked:border-[var(--brand-cyan)] transition-all"></div>
          <div class="absolute left-1 top-1 w-6 h-6 rounded-full bg-[var(--text-muted)] peer-checked:bg-white peer-checked:translate-x-6 transition-all"></div>
        </label>
      </div>
    </div>

    <!-- Prep Checklist -->
    <div class="card p-5">
      <h2 class="font-semibold text-lg text-[var(--text-primary)] mb-5 flex items-center gap-2">
        <span class="text-xl">üìã</span>
        Prep Checklist
      </h2>

      <!-- Protein -->
      <div class="mb-6">
        <h3 class="text-sm font-bold text-[var(--brand-orange)] uppercase tracking-wider mb-3 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-orange)] glow-orange"></span>
          Protein (Priority One)
        </h3>
        <div class="space-y-2">
          {tasksByCategory.protein.map(task => (
            <label class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] cursor-pointer hover:border-[var(--brand-orange)] transition-all group">
              <input type="checkbox" class="prep-task checkbox-custom" data-task={task.id} />
              <span class="flex-1 text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors">{task.task}</span>
              <span class="text-xs text-[var(--text-muted)] px-2 py-1 rounded-lg bg-[var(--bg-card)]">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Sides -->
      <div class="mb-6">
        <h3 class="text-sm font-bold text-[var(--brand-green)] uppercase tracking-wider mb-3 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-green)]"></span>
          Sides
        </h3>
        <div class="space-y-2">
          {tasksByCategory.sides.map(task => (
            <label class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] cursor-pointer hover:border-[var(--brand-green)] transition-all group">
              <input type="checkbox" class="prep-task checkbox-custom checkbox-green" data-task={task.id} />
              <span class="flex-1 text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors">{task.task}</span>
              <span class="text-xs text-[var(--text-muted)] px-2 py-1 rounded-lg bg-[var(--bg-card)]">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Snacks -->
      <div class="mb-6">
        <h3 class="text-sm font-bold text-[var(--brand-purple)] uppercase tracking-wider mb-3 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--brand-purple)]"></span>
          Snacks
        </h3>
        <div class="space-y-2">
          {tasksByCategory.snacks.map(task => (
            <label class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] cursor-pointer hover:border-[var(--brand-purple)] transition-all group">
              <input type="checkbox" class="prep-task checkbox-custom checkbox-purple" data-task={task.id} />
              <span class="flex-1 text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors">{task.task}</span>
              <span class="text-xs text-[var(--text-muted)] px-2 py-1 rounded-lg bg-[var(--bg-card)]">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- General Prep -->
      <div>
        <h3 class="text-sm font-bold text-[var(--text-secondary)] uppercase tracking-wider mb-3 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-[var(--text-secondary)]"></span>
          Setup
        </h3>
        <div class="space-y-2">
          {tasksByCategory.prep.map(task => (
            <label class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] cursor-pointer hover:border-[var(--text-secondary)] transition-all group">
              <input type="checkbox" class="prep-task checkbox-custom checkbox-gray" data-task={task.id} />
              <span class="flex-1 text-[var(--text-secondary)] group-hover:text-[var(--text-primary)] transition-colors">{task.task}</span>
              <span class="text-xs text-[var(--text-muted)] px-2 py-1 rounded-lg bg-[var(--bg-card)]">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>
    </div>

    <!-- Meal Containers -->
    <div class="card p-5">
      <h2 class="font-semibold text-lg text-[var(--text-primary)] mb-4 flex items-center gap-2">
        <span class="text-xl">üì¶</span>
        Pack Containers
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {MEAL_CONTAINERS.map(container => (
          <label class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] cursor-pointer hover:border-[var(--brand-orange)] transition-all group">
            <input type="checkbox" class="container-task checkbox-custom" data-container={container.id} />
            <div class="flex-1">
              <div class="font-medium text-[var(--text-primary)]">{container.name}</div>
              <div class="text-sm text-[var(--text-muted)]">{container.contents}</div>
            </div>
            <div class="text-right">
              <div class="text-[var(--brand-green)] font-bold">{container.protein}g</div>
              <div class="text-xs text-[var(--text-muted)]">{container.calories} cal</div>
            </div>
          </label>
        ))}
      </div>
    </div>

    <!-- Shopping List -->
    <div class="card p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg text-[var(--text-primary)] flex items-center gap-2">
          <span class="text-xl">üõí</span>
          Shopping List
        </h2>
        <button id="copy-list" class="px-4 py-2 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)] text-[var(--text-secondary)] hover:text-[var(--brand-cyan)] hover:border-[var(--brand-cyan)] transition-all text-sm">
          Copy List
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Protein -->
        <div>
          <h3 class="text-sm font-bold text-[var(--brand-orange)] uppercase tracking-wider mb-3">Protein</h3>
          <ul class="space-y-2">
            {shoppingByCategory.protein.map(item => (
              <li class="flex justify-between text-sm p-2 rounded-lg hover:bg-[var(--bg-glass)] transition-colors">
                <span class="text-[var(--text-secondary)]">{item.item}</span>
                <span class="text-[var(--text-muted)]">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Produce -->
        <div>
          <h3 class="text-sm font-bold text-[var(--brand-green)] uppercase tracking-wider mb-3">Produce</h3>
          <ul class="space-y-2">
            {shoppingByCategory.produce.map(item => (
              <li class="flex justify-between text-sm p-2 rounded-lg hover:bg-[var(--bg-glass)] transition-colors">
                <span class="text-[var(--text-secondary)]">{item.item}</span>
                <span class="text-[var(--text-muted)]">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Snacks -->
        <div>
          <h3 class="text-sm font-bold text-[var(--brand-purple)] uppercase tracking-wider mb-3">Snacks</h3>
          <ul class="space-y-2">
            {shoppingByCategory.snacks.map(item => (
              <li class="flex justify-between text-sm p-2 rounded-lg hover:bg-[var(--bg-glass)] transition-colors">
                <span class="text-[var(--text-secondary)]">{item.item}</span>
                <span class="text-[var(--text-muted)]">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Pantry -->
        <div>
          <h3 class="text-sm font-bold text-[var(--text-secondary)] uppercase tracking-wider mb-3">Pantry</h3>
          <ul class="space-y-2">
            {shoppingByCategory.pantry.map(item => (
              <li class="flex justify-between text-sm p-2 rounded-lg hover:bg-[var(--bg-glass)] transition-colors">
                <span class="text-[var(--text-secondary)]">{item.item}</span>
                <span class="text-[var(--text-muted)]">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>

    <!-- Sample Day -->
    <div class="card card-glow p-5">
      <h2 class="font-semibold text-lg text-[var(--text-primary)] mb-4 flex items-center gap-2">
        <span class="text-xl">üí™</span>
        Sample Day: <span class="text-[var(--brand-green)]">{proteinExample.totalProtein}g Protein</span>
      </h2>
      <ul class="space-y-3 mb-4">
        {proteinExample.meals.map(meal => (
          <li class="flex items-center gap-3 text-sm">
            <span class="w-6 h-6 rounded-full bg-[var(--brand-green)] bg-opacity-20 flex items-center justify-center text-[var(--brand-green)]">‚úì</span>
            <span class="text-[var(--text-secondary)]">{meal}</span>
          </li>
        ))}
      </ul>
      <div class="p-4 rounded-xl bg-[var(--bg-glass)] border border-[var(--border-color)]">
        <span class="text-[var(--text-muted)]">Daily Total:</span>
        <span class="font-bold text-[var(--brand-green)] ml-2">{proteinExample.totalProtein}g protein</span>
        <span class="text-[var(--text-muted)] mx-2">‚Ä¢</span>
        <span class="text-[var(--text-secondary)]">{proteinExample.totalCalories} calories</span>
      </div>
    </div>

    <!-- Progress -->
    <div class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-[var(--text-primary)]">Prep Progress</h3>
        <span id="progress-text" class="text-sm text-[var(--text-muted)]">0 / {PREP_TASKS.length + MEAL_CONTAINERS.length + 1} tasks</span>
      </div>
      <div class="h-3 rounded-full bg-[var(--bg-glass)] border border-[var(--border-color)] overflow-hidden">
        <div id="progress-fill" class="h-full rounded-full bg-gradient-to-r from-[var(--brand-orange)] to-[var(--brand-green)] transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>

  </div>
</Layout>

<style>
  .checkbox-custom {
    appearance: none;
    width: 1.5rem;
    height: 1.5rem;
    border: 2px solid var(--border-color);
    border-radius: 0.5rem;
    background: var(--bg-glass);
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .checkbox-custom:checked {
    background: var(--brand-orange);
    border-color: var(--brand-orange);
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3E%3C/svg%3E");
  }

  .checkbox-custom.checkbox-green:checked {
    background: var(--brand-green);
    border-color: var(--brand-green);
  }

  .checkbox-custom.checkbox-purple:checked {
    background: var(--brand-purple);
    border-color: var(--brand-purple);
  }

  .checkbox-custom.checkbox-gray:checked {
    background: var(--text-secondary);
    border-color: var(--text-secondary);
  }

  .checkbox-custom:hover {
    border-color: var(--brand-orange);
  }

  .checkbox-green:hover {
    border-color: var(--brand-green) !important;
  }

  .checkbox-purple:hover {
    border-color: var(--brand-purple) !important;
  }
</style>

<script define:vars={{ totalTasks: PREP_TASKS.length + MEAL_CONTAINERS.length + 1 }}>
  // Load saved state from localStorage
  function loadState() {
    const saved = localStorage.getItem('mealPrepState');
    if (saved) {
      const state = JSON.parse(saved);

      // Restore checkboxes
      document.querySelectorAll('.prep-task').forEach(el => {
        const taskId = el.dataset.task;
        if (state.tasks && state.tasks[taskId]) {
          el.checked = true;
        }
      });

      document.querySelectorAll('.container-task').forEach(el => {
        const containerId = el.dataset.container;
        if (state.containers && state.containers[containerId]) {
          el.checked = true;
        }
      });

      if (state.waterCheck) {
        document.getElementById('water-check').checked = true;
      }
    }
    updateProgress();
  }

  // Save state to localStorage
  function saveState() {
    const state = {
      tasks: {},
      containers: {},
      waterCheck: document.getElementById('water-check')?.checked || false
    };

    document.querySelectorAll('.prep-task').forEach(el => {
      state.tasks[el.dataset.task] = el.checked;
    });

    document.querySelectorAll('.container-task').forEach(el => {
      state.containers[el.dataset.container] = el.checked;
    });

    localStorage.setItem('mealPrepState', JSON.stringify(state));
    updateProgress();
  }

  // Update progress bar
  function updateProgress() {
    let completed = 0;

    document.querySelectorAll('.prep-task:checked').forEach(() => completed++);
    document.querySelectorAll('.container-task:checked').forEach(() => completed++);
    if (document.getElementById('water-check')?.checked) completed++;

    const percent = (completed / totalTasks) * 100;
    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-text').textContent = `${completed} / ${totalTasks} tasks`;
  }

  // Copy shopping list
  document.getElementById('copy-list')?.addEventListener('click', () => {
    const lists = document.querySelectorAll('.card ul');
    let text = 'üõí SHOPPING LIST\n\n';

    lists.forEach(list => {
      const heading = list.previousElementSibling;
      if (heading?.tagName === 'H3') {
        text += heading.textContent.toUpperCase() + ':\n';
        list.querySelectorAll('li').forEach(li => {
          text += '  ‚Ä¢ ' + li.textContent.trim().replace(/\s+/g, ' ') + '\n';
        });
        text += '\n';
      }
    });

    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-list');
      const original = btn.textContent;
      btn.textContent = '‚úì Copied!';
      btn.style.color = 'var(--brand-green)';
      btn.style.borderColor = 'var(--brand-green)';
      setTimeout(() => {
        btn.textContent = original;
        btn.style.color = '';
        btn.style.borderColor = '';
      }, 2000);
    });
  });

  // Add event listeners
  document.querySelectorAll('.prep-task, .container-task').forEach(el => {
    el.addEventListener('change', saveState);
  });
  document.getElementById('water-check')?.addEventListener('change', saveState);

  // Load on page load
  loadState();
</script>
