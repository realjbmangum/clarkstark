---
import Layout from '../layouts/Layout.astro';
import { PREP_TASKS, SHOPPING_LIST, MEAL_CONTAINERS, DAILY_TARGETS, getDailyProteinExample } from '../data/mealplan';

export const prerender = false;

const proteinExample = getDailyProteinExample();

// Group prep tasks by category
const tasksByCategory = {
  protein: PREP_TASKS.filter(t => t.category === 'protein'),
  sides: PREP_TASKS.filter(t => t.category === 'sides'),
  snacks: PREP_TASKS.filter(t => t.category === 'snacks'),
  prep: PREP_TASKS.filter(t => t.category === 'prep'),
};

// Group shopping list by category
const shoppingByCategory = {
  protein: SHOPPING_LIST.filter(i => i.category === 'protein'),
  produce: SHOPPING_LIST.filter(i => i.category === 'produce'),
  snacks: SHOPPING_LIST.filter(i => i.category === 'snacks'),
  pantry: SHOPPING_LIST.filter(i => i.category === 'pantry'),
};
---

<Layout title="Meal Prep" activeNav="meal-prep">
  <div class="space-y-6">

    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Sunday Meal Prep</h1>
        <p class="text-gray-500">~1 hour to set up the week</p>
      </div>
      <a href="/" class="btn btn-secondary text-sm">
        ‚Üê Calendar
      </a>
    </div>

    <!-- Daily Targets Reminder -->
    <div class="card bg-gradient-to-r from-green-50 to-blue-50 border-green-200">
      <h3 class="font-semibold mb-3">Daily Targets</h3>
      <div class="grid grid-cols-3 gap-4 text-center">
        <div>
          <div class="text-2xl font-bold text-green-600">{DAILY_TARGETS.protein}g</div>
          <div class="text-xs text-gray-500">Protein</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-orange-600">{DAILY_TARGETS.caloriesMin}-{DAILY_TARGETS.caloriesMax}</div>
          <div class="text-xs text-gray-500">Calories</div>
        </div>
        <div>
          <div class="text-2xl font-bold text-blue-600">{DAILY_TARGETS.waterGallons} gal</div>
          <div class="text-xs text-gray-500">Water</div>
        </div>
      </div>
    </div>

    <!-- Water Bottle Reminder -->
    <div class="card bg-blue-50 border-blue-200">
      <div class="flex items-center gap-4">
        <div class="text-4xl">üíß</div>
        <div>
          <h3 class="font-semibold text-blue-800">Water Bottle Check</h3>
          <p class="text-sm text-blue-600">Fill your 1-gallon jug for tomorrow. Keep it visible!</p>
        </div>
        <label class="ml-auto flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="water-check" class="w-5 h-5 rounded text-blue-600" />
          <span class="sr-only">Water filled</span>
        </label>
      </div>
    </div>

    <!-- Prep Checklist -->
    <div class="card">
      <h2 class="font-semibold text-lg mb-4">Prep Checklist</h2>

      <!-- Protein -->
      <div class="mb-6">
        <h3 class="text-sm font-medium text-orange-600 uppercase tracking-wide mb-3">Protein (Main Priority)</h3>
        <div class="space-y-2">
          {tasksByCategory.protein.map(task => (
            <label class="flex items-center gap-3 p-3 bg-orange-50 rounded-xl cursor-pointer hover:bg-orange-100 transition-colors">
              <input type="checkbox" class="prep-task w-5 h-5 rounded text-orange-600" data-task={task.id} />
              <span class="flex-1">{task.task}</span>
              <span class="text-xs text-gray-400">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Sides -->
      <div class="mb-6">
        <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide mb-3">Sides</h3>
        <div class="space-y-2">
          {tasksByCategory.sides.map(task => (
            <label class="flex items-center gap-3 p-3 bg-green-50 rounded-xl cursor-pointer hover:bg-green-100 transition-colors">
              <input type="checkbox" class="prep-task w-5 h-5 rounded text-green-600" data-task={task.id} />
              <span class="flex-1">{task.task}</span>
              <span class="text-xs text-gray-400">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- Snacks -->
      <div class="mb-6">
        <h3 class="text-sm font-medium text-purple-600 uppercase tracking-wide mb-3">Snacks</h3>
        <div class="space-y-2">
          {tasksByCategory.snacks.map(task => (
            <label class="flex items-center gap-3 p-3 bg-purple-50 rounded-xl cursor-pointer hover:bg-purple-100 transition-colors">
              <input type="checkbox" class="prep-task w-5 h-5 rounded text-purple-600" data-task={task.id} />
              <span class="flex-1">{task.task}</span>
              <span class="text-xs text-gray-400">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- General Prep -->
      <div>
        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide mb-3">Setup</h3>
        <div class="space-y-2">
          {tasksByCategory.prep.map(task => (
            <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors">
              <input type="checkbox" class="prep-task w-5 h-5 rounded text-gray-600" data-task={task.id} />
              <span class="flex-1">{task.task}</span>
              <span class="text-xs text-gray-400">{task.estimatedTime}</span>
            </label>
          ))}
        </div>
      </div>
    </div>

    <!-- Meal Containers -->
    <div class="card">
      <h2 class="font-semibold text-lg mb-4">Pack Containers</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {MEAL_CONTAINERS.map(container => (
          <label class="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-gray-50 transition-colors">
            <input type="checkbox" class="container-task w-5 h-5 rounded text-brand-orange" data-container={container.id} />
            <div class="flex-1">
              <div class="font-medium">{container.name}</div>
              <div class="text-sm text-gray-500">{container.contents}</div>
            </div>
            <div class="text-right text-sm">
              <div class="text-green-600 font-medium">{container.protein}g</div>
              <div class="text-gray-400">{container.calories} cal</div>
            </div>
          </label>
        ))}
      </div>
    </div>

    <!-- Shopping List -->
    <div class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold text-lg">Shopping List</h2>
        <button id="copy-list" class="btn btn-ghost text-sm">
          Copy List
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Protein -->
        <div>
          <h3 class="text-sm font-medium text-orange-600 uppercase tracking-wide mb-2">Protein</h3>
          <ul class="space-y-1">
            {shoppingByCategory.protein.map(item => (
              <li class="flex justify-between text-sm">
                <span>{item.item}</span>
                <span class="text-gray-400">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Produce -->
        <div>
          <h3 class="text-sm font-medium text-green-600 uppercase tracking-wide mb-2">Produce</h3>
          <ul class="space-y-1">
            {shoppingByCategory.produce.map(item => (
              <li class="flex justify-between text-sm">
                <span>{item.item}</span>
                <span class="text-gray-400">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Snacks -->
        <div>
          <h3 class="text-sm font-medium text-purple-600 uppercase tracking-wide mb-2">Snacks</h3>
          <ul class="space-y-1">
            {shoppingByCategory.snacks.map(item => (
              <li class="flex justify-between text-sm">
                <span>{item.item}</span>
                <span class="text-gray-400">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>

        <!-- Pantry -->
        <div>
          <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide mb-2">Pantry</h3>
          <ul class="space-y-1">
            {shoppingByCategory.pantry.map(item => (
              <li class="flex justify-between text-sm">
                <span>{item.item}</span>
                <span class="text-gray-400">{item.amount}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>

    <!-- Sample Day -->
    <div class="card bg-gradient-to-br from-amber-50 to-orange-50 border-amber-200">
      <h2 class="font-semibold text-lg mb-3">Sample Day: {proteinExample.totalProtein}g Protein</h2>
      <ul class="space-y-2 mb-4">
        {proteinExample.meals.map(meal => (
          <li class="flex items-center gap-2 text-sm">
            <span class="text-green-500">‚úì</span>
            <span>{meal}</span>
          </li>
        ))}
      </ul>
      <div class="text-sm text-gray-600">
        Total: <span class="font-semibold text-green-600">{proteinExample.totalProtein}g protein</span> ‚Ä¢ {proteinExample.totalCalories} calories
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Prep Progress</h3>
        <span id="progress-text" class="text-sm text-gray-500">0 / {PREP_TASKS.length + MEAL_CONTAINERS.length + 1} tasks</span>
      </div>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill bg-gradient-to-r from-green-400 to-green-500" style="width: 0%"></div>
      </div>
    </div>

  </div>
</Layout>

<script define:vars={{ totalTasks: PREP_TASKS.length + MEAL_CONTAINERS.length + 1 }}>
  // Load saved state from localStorage
  function loadState() {
    const saved = localStorage.getItem('mealPrepState');
    if (saved) {
      const state = JSON.parse(saved);

      // Restore checkboxes
      document.querySelectorAll('.prep-task').forEach(el => {
        const taskId = el.dataset.task;
        if (state.tasks && state.tasks[taskId]) {
          el.checked = true;
        }
      });

      document.querySelectorAll('.container-task').forEach(el => {
        const containerId = el.dataset.container;
        if (state.containers && state.containers[containerId]) {
          el.checked = true;
        }
      });

      if (state.waterCheck) {
        document.getElementById('water-check').checked = true;
      }
    }
    updateProgress();
  }

  // Save state to localStorage
  function saveState() {
    const state = {
      tasks: {},
      containers: {},
      waterCheck: document.getElementById('water-check')?.checked || false
    };

    document.querySelectorAll('.prep-task').forEach(el => {
      state.tasks[el.dataset.task] = el.checked;
    });

    document.querySelectorAll('.container-task').forEach(el => {
      state.containers[el.dataset.container] = el.checked;
    });

    localStorage.setItem('mealPrepState', JSON.stringify(state));
    updateProgress();
  }

  // Update progress bar
  function updateProgress() {
    let completed = 0;

    document.querySelectorAll('.prep-task:checked').forEach(() => completed++);
    document.querySelectorAll('.container-task:checked').forEach(() => completed++);
    if (document.getElementById('water-check')?.checked) completed++;

    const percent = (completed / totalTasks) * 100;
    document.getElementById('progress-fill').style.width = percent + '%';
    document.getElementById('progress-text').textContent = `${completed} / ${totalTasks} tasks`;
  }

  // Copy shopping list
  document.getElementById('copy-list')?.addEventListener('click', () => {
    const lists = document.querySelectorAll('.card ul');
    let text = 'Shopping List:\n\n';

    lists.forEach(list => {
      const heading = list.previousElementSibling;
      if (heading?.tagName === 'H3') {
        text += heading.textContent + ':\n';
        list.querySelectorAll('li').forEach(li => {
          text += '  - ' + li.textContent.trim().replace(/\s+/g, ' ') + '\n';
        });
        text += '\n';
      }
    });

    navigator.clipboard.writeText(text).then(() => {
      const btn = document.getElementById('copy-list');
      const original = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = original, 2000);
    });
  });

  // Add event listeners
  document.querySelectorAll('.prep-task, .container-task').forEach(el => {
    el.addEventListener('change', saveState);
  });
  document.getElementById('water-check')?.addEventListener('change', saveState);

  // Load on page load
  loadState();
</script>
