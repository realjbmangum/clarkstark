---
import Layout from '../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="Recipes" activeNav="recipes">
  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Recipes</h1>
        <p class="text-gray-500">High-protein meals for gains</p>
      </div>
      <button id="add-recipe-btn" class="btn btn-primary">+ Add Recipe</button>
    </div>

    <!-- Filters -->
    <div class="flex gap-2 flex-wrap">
      <button class="filter-btn btn btn-secondary active" data-category="">All</button>
      <button class="filter-btn btn btn-ghost" data-category="breakfast">Breakfast</button>
      <button class="filter-btn btn btn-ghost" data-category="lunch">Lunch</button>
      <button class="filter-btn btn btn-ghost" data-category="dinner">Dinner</button>
      <button class="filter-btn btn btn-ghost" data-category="snack">Snack</button>
      <button class="filter-btn btn btn-ghost" data-category="shake">Shake</button>
    </div>

    <!-- Recipes Grid -->
    <div id="recipes-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      <p class="text-gray-400 col-span-full text-center py-8">Loading recipes...</p>
    </div>

    <!-- Add/Edit Recipe Modal -->
    <div id="recipe-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4" id="modal-title">Add Recipe</h2>
        <form id="recipe-form" class="space-y-4">
          <input type="hidden" id="recipe-id" />
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
              <label class="block text-sm text-gray-500 mb-1">Recipe Name</label>
              <input type="text" id="recipe-name" required class="w-full" placeholder="Protein Power Bowl" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Category</label>
              <select id="recipe-category" class="w-full">
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
                <option value="shake">Shake</option>
              </select>
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Servings</label>
              <input type="number" id="recipe-servings" value="1" class="w-full" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Prep Time (min)</label>
              <input type="number" id="recipe-prep" class="w-full" placeholder="10" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Cook Time (min)</label>
              <input type="number" id="recipe-cook" class="w-full" placeholder="20" />
            </div>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm text-gray-500 mb-1">Calories</label>
              <input type="number" id="recipe-calories" class="w-full" placeholder="400" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Protein (g)</label>
              <input type="number" id="recipe-protein" class="w-full" placeholder="40" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Carbs (g)</label>
              <input type="number" id="recipe-carbs" class="w-full" placeholder="30" />
            </div>
            <div>
              <label class="block text-sm text-gray-500 mb-1">Fat (g)</label>
              <input type="number" id="recipe-fat" class="w-full" placeholder="15" />
            </div>
          </div>

          <div>
            <label class="block text-sm text-gray-500 mb-1">Ingredients (one per line)</label>
            <textarea id="recipe-ingredients" rows="4" class="w-full" placeholder="1 lb chicken breast&#10;2 cups rice&#10;1 cup broccoli"></textarea>
          </div>

          <div>
            <label class="block text-sm text-gray-500 mb-1">Instructions (one step per line)</label>
            <textarea id="recipe-instructions" rows="4" class="w-full" placeholder="Season chicken with salt and pepper&#10;Grill for 6-7 minutes per side&#10;Serve over rice with broccoli"></textarea>
          </div>

          <div>
            <label class="block text-sm text-gray-500 mb-1">Notes</label>
            <input type="text" id="recipe-notes" class="w-full" placeholder="Great for meal prep" />
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="recipe-favorite" class="rounded" />
            <label for="recipe-favorite" class="text-sm">Mark as favorite</label>
          </div>

          <div class="flex gap-4">
            <button type="submit" class="btn btn-primary">Save Recipe</button>
            <button type="button" id="cancel-modal" class="btn btn-ghost">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<script>
  let currentCategory = '';

  async function loadRecipes(category = '') {
    try {
      let url = '/api/recipes';
      if (category) url += `?category=${category}`;

      const res = await fetch(url);
      const data = await res.json();
      const recipes = data.recipes || [];

      const grid = document.getElementById('recipes-grid')!;

      if (recipes.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <p class="text-gray-400 mb-4">No recipes yet</p>
            <button onclick="document.getElementById('add-recipe-btn')?.click()" class="btn btn-primary">Add Your First Recipe</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = recipes.map((r: any) => `
        <div class="card hover:shadow-md transition-shadow cursor-pointer" data-recipe-id="${r.id}">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-semibold">${r.name}</h3>
            ${r.favorite ? '<span class="text-yellow-500">â˜…</span>' : ''}
          </div>
          <div class="text-sm text-gray-500 mb-3">${r.category}</div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-center text-sm">
            <div>
              <div class="font-medium">${r.calories || '-'}</div>
              <div class="text-xs text-gray-400">cal</div>
            </div>
            <div>
              <div class="font-medium text-green-600">${r.protein || '-'}g</div>
              <div class="text-xs text-gray-400">protein</div>
            </div>
            <div>
              <div class="font-medium text-blue-600">${r.carbs || '-'}g</div>
              <div class="text-xs text-gray-400">carbs</div>
            </div>
            <div>
              <div class="font-medium text-yellow-600">${r.fat || '-'}g</div>
              <div class="text-xs text-gray-400">fat</div>
            </div>
          </div>
          ${r.prep_time || r.cook_time ? `
            <div class="text-xs text-gray-400 mt-3">
              ${r.prep_time ? `Prep: ${r.prep_time}min` : ''}
              ${r.cook_time ? `Cook: ${r.cook_time}min` : ''}
            </div>
          ` : ''}
        </div>
      `).join('');

      // Add click handlers for editing
      grid.querySelectorAll('[data-recipe-id]').forEach(card => {
        card.addEventListener('click', () => {
          const id = (card as HTMLElement).dataset.recipeId;
          editRecipe(id!);
        });
      });

    } catch (err) {
      console.error('Failed to load recipes:', err);
    }
  }

  async function editRecipe(id: string) {
    try {
      const res = await fetch(`/api/recipes?id=${id}`);
      const data = await res.json();
      const recipe = data.recipe;

      if (recipe) {
        document.getElementById('modal-title')!.textContent = 'Edit Recipe';
        (document.getElementById('recipe-id') as HTMLInputElement).value = recipe.id;
        (document.getElementById('recipe-name') as HTMLInputElement).value = recipe.name;
        (document.getElementById('recipe-category') as HTMLSelectElement).value = recipe.category;
        (document.getElementById('recipe-servings') as HTMLInputElement).value = recipe.servings || '1';
        (document.getElementById('recipe-prep') as HTMLInputElement).value = recipe.prep_time || '';
        (document.getElementById('recipe-cook') as HTMLInputElement).value = recipe.cook_time || '';
        (document.getElementById('recipe-calories') as HTMLInputElement).value = recipe.calories || '';
        (document.getElementById('recipe-protein') as HTMLInputElement).value = recipe.protein || '';
        (document.getElementById('recipe-carbs') as HTMLInputElement).value = recipe.carbs || '';
        (document.getElementById('recipe-fat') as HTMLInputElement).value = recipe.fat || '';
        (document.getElementById('recipe-notes') as HTMLInputElement).value = recipe.notes || '';
        (document.getElementById('recipe-favorite') as HTMLInputElement).checked = recipe.favorite === 1;

        // Parse JSON arrays
        const ingredients = recipe.ingredients ? JSON.parse(recipe.ingredients) : [];
        const instructions = recipe.instructions ? JSON.parse(recipe.instructions) : [];
        (document.getElementById('recipe-ingredients') as HTMLTextAreaElement).value = ingredients.join('\n');
        (document.getElementById('recipe-instructions') as HTMLTextAreaElement).value = instructions.join('\n');

        showModal();
      }
    } catch (err) {
      console.error('Failed to load recipe:', err);
    }
  }

  function showModal() {
    document.getElementById('recipe-modal')?.classList.remove('hidden');
    document.getElementById('recipe-modal')?.classList.add('flex');
  }

  function hideModal() {
    document.getElementById('recipe-modal')?.classList.add('hidden');
    document.getElementById('recipe-modal')?.classList.remove('flex');
    // Reset form
    (document.getElementById('recipe-form') as HTMLFormElement).reset();
    (document.getElementById('recipe-id') as HTMLInputElement).value = '';
    document.getElementById('modal-title')!.textContent = 'Add Recipe';
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active', 'btn-secondary');
        b.classList.add('btn-ghost');
      });
      (e.target as HTMLElement).classList.add('active', 'btn-secondary');
      (e.target as HTMLElement).classList.remove('btn-ghost');

      currentCategory = (e.target as HTMLElement).dataset.category || '';
      loadRecipes(currentCategory);
    });
  });

  // Modal controls
  document.getElementById('add-recipe-btn')?.addEventListener('click', () => {
    document.getElementById('modal-title')!.textContent = 'Add Recipe';
    showModal();
  });

  document.getElementById('cancel-modal')?.addEventListener('click', hideModal);

  document.getElementById('recipe-modal')?.addEventListener('click', (e) => {
    if (e.target === document.getElementById('recipe-modal')) hideModal();
  });

  // Form submission
  document.getElementById('recipe-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const ingredients = (document.getElementById('recipe-ingredients') as HTMLTextAreaElement).value
      .split('\n')
      .filter(line => line.trim());

    const instructions = (document.getElementById('recipe-instructions') as HTMLTextAreaElement).value
      .split('\n')
      .filter(line => line.trim());

    const data = {
      id: (document.getElementById('recipe-id') as HTMLInputElement).value || undefined,
      name: (document.getElementById('recipe-name') as HTMLInputElement).value,
      category: (document.getElementById('recipe-category') as HTMLSelectElement).value,
      servings: parseInt((document.getElementById('recipe-servings') as HTMLInputElement).value) || 1,
      prep_time: parseInt((document.getElementById('recipe-prep') as HTMLInputElement).value) || null,
      cook_time: parseInt((document.getElementById('recipe-cook') as HTMLInputElement).value) || null,
      calories: parseInt((document.getElementById('recipe-calories') as HTMLInputElement).value) || null,
      protein: parseInt((document.getElementById('recipe-protein') as HTMLInputElement).value) || null,
      carbs: parseInt((document.getElementById('recipe-carbs') as HTMLInputElement).value) || null,
      fat: parseInt((document.getElementById('recipe-fat') as HTMLInputElement).value) || null,
      ingredients,
      instructions,
      notes: (document.getElementById('recipe-notes') as HTMLInputElement).value || null,
      favorite: (document.getElementById('recipe-favorite') as HTMLInputElement).checked
    };

    try {
      const res = await fetch('/api/recipes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        hideModal();
        loadRecipes(currentCategory);
      }
    } catch (err) {
      console.error('Failed to save recipe:', err);
    }
  });

  loadRecipes();
</script>

<style>
  .filter-btn.active {
    @apply bg-gray-200;
  }
</style>
